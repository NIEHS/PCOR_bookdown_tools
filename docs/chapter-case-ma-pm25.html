<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 Air Quality, Income, and Asthma | The CHORDS Toolkit for Health and Geospatial Exposures Research</title>
  <meta name="description" content="The CHORDS Toolkit provides guides, tools, and example code to support climate change and human health research." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="6 Air Quality, Income, and Asthma | The CHORDS Toolkit for Health and Geospatial Exposures Research" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="The CHORDS Toolkit provides guides, tools, and example code to support climate change and human health research." />
  <meta name="github-repo" content="NIEHS/PCOR_bookdown_tools" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Air Quality, Income, and Asthma | The CHORDS Toolkit for Health and Geospatial Exposures Research" />
  
  <meta name="twitter:description" content="The CHORDS Toolkit provides guides, tools, and example code to support climate change and human health research." />
  

<meta name="author" content="" />


<meta name="date" content="2024-04-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="case-studies.html"/>
<link rel="next" href="appendix.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./"><img src="images/chords-icon-nobackground.png" width="200"></a></li>
<li><a href="./">CHORDS Toolkit</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><strong>Introduction</strong></a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-chords"><i class="fa fa-check"></i>About CHORDS</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-this-toolkit"><i class="fa fa-check"></i>About This Toolkit</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="foundations.html"><a href="foundations.html"><i class="fa fa-check"></i><strong>Foundations</strong></a></li>
<li class="chapter" data-level="1" data-path="chapter-intro-spatial-data-analysis.html"><a href="chapter-intro-spatial-data-analysis.html"><i class="fa fa-check"></i><b>1</b> Spatial Data Analysis</a>
<ul>
<li class="chapter" data-level="1.1" data-path="chapter-intro-spatial-data-analysis.html"><a href="chapter-intro-spatial-data-analysis.html#introduction-1"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="chapter-intro-spatial-data-analysis.html"><a href="chapter-intro-spatial-data-analysis.html#point-data-with-sf"><i class="fa fa-check"></i><b>1.2</b> Point Data with <code>sf</code></a></li>
<li class="chapter" data-level="1.3" data-path="chapter-intro-spatial-data-analysis.html"><a href="chapter-intro-spatial-data-analysis.html#polygon-data"><i class="fa fa-check"></i><b>1.3</b> Polygon Data</a></li>
<li class="chapter" data-level="1.4" data-path="chapter-intro-spatial-data-analysis.html"><a href="chapter-intro-spatial-data-analysis.html#raster-data-with-terra"><i class="fa fa-check"></i><b>1.4</b> Raster Data with <code>terra</code></a></li>
<li class="chapter" data-level="1.5" data-path="chapter-intro-spatial-data-analysis.html"><a href="chapter-intro-spatial-data-analysis.html#additional-resources"><i class="fa fa-check"></i><b>1.5</b> Additional Resources</a></li>
<li class="chapter" data-level="1.6" data-path="chapter-intro-spatial-data-analysis.html"><a href="chapter-intro-spatial-data-analysis.html#references"><i class="fa fa-check"></i><b>1.6</b> References</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="wildfire-data.html"><a href="wildfire-data.html"><i class="fa fa-check"></i><strong>Wildfire Data</strong></a></li>
<li class="chapter" data-level="2" data-path="wildfire-chapter.html"><a href="wildfire-chapter.html"><i class="fa fa-check"></i><b>2</b> Wildfire Chapter</a></li>
<li class="chapter" data-level="" data-path="other-environmental-data.html"><a href="other-environmental-data.html"><i class="fa fa-check"></i><strong>Other Environmental Data</strong></a></li>
<li class="chapter" data-level="3" data-path="chapter-nasa-earthdata.html"><a href="chapter-nasa-earthdata.html"><i class="fa fa-check"></i><b>3</b> NASA EarthData Download</a>
<ul>
<li class="chapter" data-level="3.1" data-path="chapter-nasa-earthdata.html"><a href="chapter-nasa-earthdata.html#introduction-2"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="chapter-nasa-earthdata.html"><a href="chapter-nasa-earthdata.html#nasa-earthdata-account"><i class="fa fa-check"></i><b>3.2</b> NASA EarthData Account</a></li>
<li class="chapter" data-level="3.3" data-path="chapter-nasa-earthdata.html"><a href="chapter-nasa-earthdata.html#references-1"><i class="fa fa-check"></i><b>3.3</b> References</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="health-data-integration.html"><a href="health-data-integration.html"><i class="fa fa-check"></i><strong>Health Data Integration</strong></a></li>
<li class="chapter" data-level="4" data-path="chapter-link-to-census.html"><a href="chapter-link-to-census.html"><i class="fa fa-check"></i><b>4</b> Linkage to Census Units</a>
<ul>
<li class="chapter" data-level="4.1" data-path="chapter-link-to-census.html"><a href="chapter-link-to-census.html#introduction-3"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="chapter-link-to-census.html"><a href="chapter-link-to-census.html#tutorial"><i class="fa fa-check"></i><b>4.2</b> Tutorial</a></li>
<li class="chapter" data-level="4.3" data-path="chapter-link-to-census.html"><a href="chapter-link-to-census.html#concluding-remarks"><i class="fa fa-check"></i><b>4.3</b> Concluding Remarks</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="chapter-chords-geo-exposures.html"><a href="chapter-chords-geo-exposures.html"><i class="fa fa-check"></i><b>5</b> Linkage to Exposures</a>
<ul>
<li class="chapter" data-level="5.1" data-path="chapter-chords-geo-exposures.html"><a href="chapter-chords-geo-exposures.html#introduction-4"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="chapter-chords-geo-exposures.html"><a href="chapter-chords-geo-exposures.html#chapter-geo-exposure-caces"><i class="fa fa-check"></i><b>5.2</b> CACES Air Pollution</a></li>
<li class="chapter" data-level="5.3" data-path="chapter-chords-geo-exposures.html"><a href="chapter-chords-geo-exposures.html#chapter-geo-exposure-faa"><i class="fa fa-check"></i><b>5.3</b> Airport Proximity</a></li>
<li class="chapter" data-level="5.4" data-path="chapter-chords-geo-exposures.html"><a href="chapter-chords-geo-exposures.html#chapter-geo-exposure-roads"><i class="fa fa-check"></i><b>5.4</b> Major Road Proximity</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="case-studies.html"><a href="case-studies.html"><i class="fa fa-check"></i><strong>Case Studies</strong></a></li>
<li class="chapter" data-level="6" data-path="chapter-case-ma-pm25.html"><a href="chapter-case-ma-pm25.html"><i class="fa fa-check"></i><b>6</b> Air Quality, Income, and Asthma</a>
<ul>
<li class="chapter" data-level="6.1" data-path="chapter-case-ma-pm25.html"><a href="chapter-case-ma-pm25.html#introduction-5"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="chapter-case-ma-pm25.html"><a href="chapter-case-ma-pm25.html#data-preparation-and-integration"><i class="fa fa-check"></i><b>6.2</b> Data Preparation and Integration</a></li>
<li class="chapter" data-level="6.3" data-path="chapter-case-ma-pm25.html"><a href="chapter-case-ma-pm25.html#data-exploration-and-vizualization"><i class="fa fa-check"></i><b>6.3</b> Data Exploration and Vizualization</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><strong>Appendix</strong></a></li>
<li class="chapter" data-level="" data-path="chapter-user-profiles.html"><a href="chapter-user-profiles.html"><i class="fa fa-check"></i><strong>A</strong> User Profiles</a></li>
<li class="chapter" data-level="" data-path="chords-glossary.html"><a href="chords-glossary.html"><i class="fa fa-check"></i><strong>B</strong> CHORDS Glossary</a></li>
<li class="chapter" data-level="" data-path="all-references-appendix.html"><a href="all-references-appendix.html"><i class="fa fa-check"></i><strong>C</strong> References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" 
target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The CHORDS Toolkit for Health and Geospatial Exposures Research</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="chapter-case-ma-pm25" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">6</span> Air Quality, Income, and Asthma<a href="chapter-case-ma-pm25.html#chapter-case-ma-pm25" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><a href="chapter-user-profiles.html#profilestu"><img src="images/user_profiles/profilestu.svg" alt="Profile-STU" /></a></p>
<div id="integrating-and-analyzing-air-quality-income-and-asthma-related-emergency-department-visits-with-synthetic-patient-data-in-r" class="section level3 unnumbered hasAnchor">
<h3>Integrating and Analyzing Air Quality, Income and Asthma-Related Emergency Department Visits with Synthetic Patient Data in R<a href="chapter-case-ma-pm25.html#integrating-and-analyzing-air-quality-income-and-asthma-related-emergency-department-visits-with-synthetic-patient-data-in-r" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Date Modified</strong>: February 21, 2024</p>
<p><strong>Authors</strong>: Sue Nolte, Lara P. Clark <a href="https://orcid.org/0000-0001-6940-5442"><img src="images/orcid.png" width="10" alt="author-lpc" /></a>, Charles Schmitt <a href="https://orcid.org/0000-0002-3148-2263"><img src="images/orcid.png" width="10" alt="author-cps" /></a></p>
<p><strong>Key Terms</strong>: <a href="https://tools.niehs.nih.gov/cchhglossary/?keyword=exposure&amp;termOnlySearch=true&amp;exactSearch=true">Exposure</a>, <a href="https://tools.niehs.nih.gov/cchhglossary/?keyword=data+integration&amp;termOnlySearch=true&amp;exactSearch=true">Data Integration</a>, <a href="https://tools.niehs.nih.gov/cchhglossary/?keyword=social+determinants+of+health+(sdoh)&amp;termOnlySearch=true&amp;exactSearch=true">Social Determinants of Health</a></p>
<p><strong>Programming Languages</strong>: R, Python</p>
</div>
<div id="introduction-5" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Introduction<a href="chapter-case-ma-pm25.html#introduction-5" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This case uses synthetic patient data to demonstrate a data integration pipeline for a study of asthma-related emergency department visits, air pollution, and social determinants of health. This case links air pollution data to the synthetic patients’ geocoded home addresses during shorter-term time periods (days) before asthma-related emergency department visits.</p>
</div>
<div id="data-preparation-and-integration" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Data Preparation and Integration<a href="chapter-case-ma-pm25.html#data-preparation-and-integration" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="synthetic-patient-data-preparation" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Synthetic Patient Data Preparation<a href="chapter-case-ma-pm25.html#synthetic-patient-data-preparation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Data set is from Synthetic patient and population health data from the state of Massachusetts.</p>
<ol style="list-style-type: decimal">
<li><p>Download complete patients FHIR file from <a href="https://synthea.mitre.org/downloads" class="uri">https://synthea.mitre.org/downloads</a> 22G zip tar</p></li>
<li><p>Developed python <a href="https://github.com/NIEHS/pcor_climate_tools/blob/main/geospatial_analysis/data_wrangling/fhir_dataset.py" title="File github location">fhir_dataset.py</a> to pull the patients information : patientid, lat, lon, birthdate, gender , start_date_time, end_date_time, code, code_display, start_date, end_date Total patients: 1 million patients</p>
<p>sample result: ran synthea_1m_fhir_3_0_May_24/output_12 code =183478001</p>
<p>output file : patient_encounts_bycode_v2_12.csv</p></li>
<li><p>QC dataset. for instance : start date &gt; end date ; misplace birth/death date to hospital stay date<br />
</p></li>
</ol>
</div>
<div id="air-quality-data-linkage" class="section level3 hasAnchor" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Air Quality Data Linkage<a href="chapter-case-ma-pm25.html#air-quality-data-linkage" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol start="4" style="list-style-type: decimal">
<li><p>Using the start/end date from patients file run DeGauss pm2.5 model <a href="https://degauss.org/pm/" class="uri">https://degauss.org/pm/</a></p>
<p>input file for pm2.5 from step 2
command line:docker run –rm -v $PWD:/tmp ghcr.io/degauss-org/pm:0.2.0 tmp/yourdatafile.csv</p></li>
<li><p>The following columns been added for each row:</p>
<p>pm_pred : predicted PM2.5 (micrograms per cubic meter)</p>
<p>pm_se : standard error for predicted PM2.5</p>
<p>Output file: patient_encounts_bycode_v2_12_pm_0.2.0.csv</p></li>
</ol>
<p>The output file will contain one row per day between start_date and end_date for everyone. Lat(latitude) and lon (longitude) location. This means that the output file will likely contain many more rows than the input file</p>
</div>
<div id="census-geoid-linkage" class="section level3 hasAnchor" number="6.2.3">
<h3><span class="header-section-number">6.2.3</span> Census Geoid Linkage<a href="chapter-case-ma-pm25.html#census-geoid-linkage" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol start="6" style="list-style-type: decimal">
<li><p>Run deGUAUSS census block group : <a href="https://degauss.org/census_block_group/" class="uri">https://degauss.org/census_block_group/</a> Produced a file with additional columns:</p>
<p>• census_block_group_id_2010: identifier for 2010 block group</p>
<p>• census_tract_id_2010: identifier for 2010 tract</p>
<p>Output file: patient_encounts_bycode_v2_12_pm_0.2.0_census_block_group_0.6.0_2010.csv
rename to:ms_patient_pm_census_v2.csv</p></li>
</ol>
</div>
</div>
<div id="data-exploration-and-vizualization" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Data Exploration and Vizualization<a href="chapter-case-ma-pm25.html#data-exploration-and-vizualization" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="mapping-linked-air-pollution-data" class="section level3 hasAnchor" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> Mapping Linked Air Pollution Data<a href="chapter-case-ma-pm25.html#mapping-linked-air-pollution-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="chapter-case-ma-pm25.html#cb158-1" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb158-2"><a href="chapter-case-ma-pm25.html#cb158-2" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;./dataset/ms_patient_pm_census_v2.csv&quot;</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="chapter-case-ma-pm25.html#cb159-1" tabindex="-1"></a><span class="fu">dim</span>(df)</span></code></pre></div>
<pre><code>## [1] 2979   19</code></pre>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="chapter-case-ma-pm25.html#cb161-1" tabindex="-1"></a><span class="fu">colnames</span>(df)</span></code></pre></div>
<pre><code>##  [1] &quot;patientid&quot;                  &quot;lat&quot;                       
##  [3] &quot;lon&quot;                        &quot;birthdate&quot;                 
##  [5] &quot;gender&quot;                     &quot;start_date_time&quot;           
##  [7] &quot;end_date_time&quot;              &quot;code&quot;                      
##  [9] &quot;code_display&quot;               &quot;start_date&quot;                
## [11] &quot;end_date&quot;                   &quot;date&quot;                      
## [13] &quot;year&quot;                       &quot;h3&quot;                        
## [15] &quot;h3_3&quot;                       &quot;pm_pred&quot;                   
## [17] &quot;pm_se&quot;                      &quot;census_block_group_id_2010&quot;
## [19] &quot;census_tract_id_2010&quot;</code></pre>
<p>Install packages:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="chapter-case-ma-pm25.html#cb163-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;shiny&quot;</span>) <span class="sc">||</span></span>
<span id="cb163-2"><a href="chapter-case-ma-pm25.html#cb163-2" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;tidycensus&quot;</span>) <span class="sc">||</span></span>
<span id="cb163-3"><a href="chapter-case-ma-pm25.html#cb163-3" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;tidyverse&quot;</span>) <span class="sc">||</span></span>
<span id="cb163-4"><a href="chapter-case-ma-pm25.html#cb163-4" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;viridis&quot;</span>)) {</span>
<span id="cb163-5"><a href="chapter-case-ma-pm25.html#cb163-5" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;tidycensus&quot;</span>, <span class="st">&quot;tidyverse&quot;</span>, <span class="st">&quot;viridis&quot;</span>))</span>
<span id="cb163-6"><a href="chapter-case-ma-pm25.html#cb163-6" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Loading required package: shiny</code></pre>
<pre><code>## Loading required package: tidycensus</code></pre>
<pre><code>## Loading required package: tidyverse</code></pre>
<pre><code>## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
## ✔ dplyr     1.1.2     ✔ purrr     1.0.1
## ✔ forcats   1.0.0     ✔ stringr   1.5.0
## ✔ ggplot2   3.4.2     ✔ tibble    3.2.1
## ✔ lubridate 1.9.2     ✔ tidyr     1.3.0
## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()
## ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors
## Loading required package: viridis
## 
## Loading required package: viridisLite</code></pre>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="chapter-case-ma-pm25.html#cb168-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;plotly&quot;</span>)) {</span>
<span id="cb168-2"><a href="chapter-case-ma-pm25.html#cb168-2" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">&quot;plotly&quot;</span>, <span class="at">type =</span> <span class="st">&quot;source&quot;</span>)</span>
<span id="cb168-3"><a href="chapter-case-ma-pm25.html#cb168-3" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Loading required package: plotly
## 
## Attaching package: &#39;plotly&#39;
## 
## The following object is masked from &#39;package:ggplot2&#39;:
## 
##     last_plot
## 
## The following object is masked from &#39;package:stats&#39;:
## 
##     filter
## 
## The following object is masked from &#39;package:graphics&#39;:
## 
##     layout</code></pre>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="chapter-case-ma-pm25.html#cb170-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;ggplot2&quot;</span>)) {</span>
<span id="cb170-2"><a href="chapter-case-ma-pm25.html#cb170-2" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb170-3"><a href="chapter-case-ma-pm25.html#cb170-3" tabindex="-1"></a>}</span>
<span id="cb170-4"><a href="chapter-case-ma-pm25.html#cb170-4" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;maps&quot;</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;ggmap&quot;</span>)) {</span>
<span id="cb170-5"><a href="chapter-case-ma-pm25.html#cb170-5" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">&quot;maps&quot;</span>, <span class="st">&quot;ggmap&quot;</span>))</span>
<span id="cb170-6"><a href="chapter-case-ma-pm25.html#cb170-6" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Loading required package: maps</code></pre>
<pre><code>## 
## Attaching package: &#39;maps&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:viridis&#39;:
## 
##     unemp</code></pre>
<pre><code>## The following object is masked from &#39;package:purrr&#39;:
## 
##     map</code></pre>
<pre><code>## Loading required package: ggmap</code></pre>
<pre><code>## ℹ Google&#39;s Terms of Service: &lt;https://mapsplatform.google.com&gt;
## ℹ Please cite ggmap if you use it! Use `citation(&quot;ggmap&quot;)` for details.
## 
## Attaching package: &#39;ggmap&#39;
## 
## 
## The following object is masked from &#39;package:plotly&#39;:
## 
##     wind</code></pre>
<p>Note that the echo = FALSE parameter was added to the code chunk to prevent printing of the R code that generated the plot.</p>
<div id="new-session" class="section level4 unlisted unnumbered hasAnchor">
<h4>Load Libraries<a href="chapter-case-ma-pm25.html#new-session" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Data wrangling:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="chapter-case-ma-pm25.html#cb177-1" tabindex="-1"></a><span class="co"># Check for missing values</span></span>
<span id="cb177-2"><a href="chapter-case-ma-pm25.html#cb177-2" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(df))</span></code></pre></div>
<pre><code>## [1] 514</code></pre>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="chapter-case-ma-pm25.html#cb179-1" tabindex="-1"></a><span class="co"># If there are missing values, you can drop or fill them as per your requirement</span></span>
<span id="cb179-2"><a href="chapter-case-ma-pm25.html#cb179-2" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(df) <span class="co"># Drop rows with missing values</span></span></code></pre></div>
<p>Change column name for later map:</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="chapter-case-ma-pm25.html#cb180-1" tabindex="-1"></a><span class="fu">colnames</span>(df)[<span class="fu">which</span>(<span class="fu">names</span>(df) <span class="sc">==</span> <span class="st">&quot;lon&quot;</span>)] <span class="ot">&lt;-</span> <span class="st">&quot;longitude&quot;</span></span>
<span id="cb180-2"><a href="chapter-case-ma-pm25.html#cb180-2" tabindex="-1"></a><span class="fu">colnames</span>(df)[<span class="fu">which</span>(<span class="fu">names</span>(df) <span class="sc">==</span> <span class="st">&quot;lat&quot;</span>)] <span class="ot">&lt;-</span> <span class="st">&quot;latitude&quot;</span></span>
<span id="cb180-3"><a href="chapter-case-ma-pm25.html#cb180-3" tabindex="-1"></a><span class="fu">dim</span>(df)</span></code></pre></div>
<pre><code>## [1] 2722   19</code></pre>
<p>Filter the rows based on the date range Use the subset() function to filter the rows based on the date range:2010 -2017to match 5 year sensus data</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="chapter-case-ma-pm25.html#cb182-1" tabindex="-1"></a>filtered_df <span class="ot">&lt;-</span></span>
<span id="cb182-2"><a href="chapter-case-ma-pm25.html#cb182-2" tabindex="-1"></a>  <span class="fu">subset</span>(df, date <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">&quot;2012-01-01&quot;</span>) <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> <span class="fu">as.Date</span>(<span class="st">&quot;2017-09-01&quot;</span>))</span>
<span id="cb182-3"><a href="chapter-case-ma-pm25.html#cb182-3" tabindex="-1"></a><span class="fu">dim</span>(filtered_df)</span></code></pre></div>
<pre><code>## [1] 2124   19</code></pre>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="chapter-case-ma-pm25.html#cb184-1" tabindex="-1"></a><span class="fu">write.csv</span>(filtered_df, <span class="st">&quot;./dataset/asthma_small.csv&quot;</span>)</span></code></pre></div>
<p>Combine information for display in tooltip</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="chapter-case-ma-pm25.html#cb185-1" tabindex="-1"></a><span class="co"># Combine the required information for hover tooltip into a new column</span></span>
<span id="cb185-2"><a href="chapter-case-ma-pm25.html#cb185-2" tabindex="-1"></a>filtered_df<span class="sc">$</span>tooltip <span class="ot">&lt;-</span> <span class="fu">paste</span>(</span>
<span id="cb185-3"><a href="chapter-case-ma-pm25.html#cb185-3" tabindex="-1"></a>  <span class="st">&quot;PM2.5:&quot;</span>, filtered_df<span class="sc">$</span>pm_pred, <span class="st">&quot;&lt;br&gt;&quot;</span>,</span>
<span id="cb185-4"><a href="chapter-case-ma-pm25.html#cb185-4" tabindex="-1"></a>  <span class="st">&quot;Hospital Date:&quot;</span>, filtered_df<span class="sc">$</span>date, <span class="st">&quot;&lt;br&gt;&quot;</span>,</span>
<span id="cb185-5"><a href="chapter-case-ma-pm25.html#cb185-5" tabindex="-1"></a>  <span class="st">&quot;Patient Info:&quot;</span>, filtered_df<span class="sc">$</span>code_display, <span class="st">&quot;&lt;br&gt;&quot;</span>,</span>
<span id="cb185-6"><a href="chapter-case-ma-pm25.html#cb185-6" tabindex="-1"></a>  <span class="st">&quot;gender :&quot;</span>, filtered_df<span class="sc">$</span>gender</span>
<span id="cb185-7"><a href="chapter-case-ma-pm25.html#cb185-7" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="create-map" class="section level4 unnumbered hasAnchor">
<h4>Create Map<a href="chapter-case-ma-pm25.html#create-map" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Load the required libraries for plotting maps:</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="chapter-case-ma-pm25.html#cb186-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb186-2"><a href="chapter-case-ma-pm25.html#cb186-2" tabindex="-1"></a><span class="fu">library</span>(maps)</span>
<span id="cb186-3"><a href="chapter-case-ma-pm25.html#cb186-3" tabindex="-1"></a><span class="fu">library</span>(ggmap)</span></code></pre></div>
<p>Add map data to the base plot using the map_data() function:</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="chapter-case-ma-pm25.html#cb187-1" tabindex="-1"></a><span class="co"># Draw massachusetts map</span></span>
<span id="cb187-2"><a href="chapter-case-ma-pm25.html#cb187-2" tabindex="-1"></a>ma_map <span class="ot">&lt;-</span> <span class="fu">map_data</span>(<span class="st">&quot;state&quot;</span>, <span class="at">region =</span> <span class="st">&quot;massachusetts&quot;</span>)</span>
<span id="cb187-3"><a href="chapter-case-ma-pm25.html#cb187-3" tabindex="-1"></a></span>
<span id="cb187-4"><a href="chapter-case-ma-pm25.html#cb187-4" tabindex="-1"></a><span class="co"># Create a base plot for Massachusetts</span></span>
<span id="cb187-5"><a href="chapter-case-ma-pm25.html#cb187-5" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb187-6"><a href="chapter-case-ma-pm25.html#cb187-6" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(</span>
<span id="cb187-7"><a href="chapter-case-ma-pm25.html#cb187-7" tabindex="-1"></a>    <span class="at">data =</span> ma_map, <span class="fu">aes</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat, <span class="at">group =</span> group),</span>
<span id="cb187-8"><a href="chapter-case-ma-pm25.html#cb187-8" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb187-9"><a href="chapter-case-ma-pm25.html#cb187-9" tabindex="-1"></a>  )</span></code></pre></div>
</div>
<div id="plotting-the-data-points" class="section level4 unnumbered hasAnchor">
<h4>Plotting the Data Points<a href="chapter-case-ma-pm25.html#plotting-the-data-points" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Plot the data points on the map using the geom_point() function. Specify the longitude and latitude coordinates, and optionally, the color or size of the data points based on the PM2.5 values:</p>
<p>Add PM2.5 data points with hover information</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="chapter-case-ma-pm25.html#cb188-1" tabindex="-1"></a>p <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">data =</span> filtered_df, <span class="fu">aes</span>(</span>
<span id="cb188-2"><a href="chapter-case-ma-pm25.html#cb188-2" tabindex="-1"></a>  <span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">color =</span> pm_pred,</span>
<span id="cb188-3"><a href="chapter-case-ma-pm25.html#cb188-3" tabindex="-1"></a>  <span class="at">text =</span> tooltip</span>
<span id="cb188-4"><a href="chapter-case-ma-pm25.html#cb188-4" tabindex="-1"></a>), <span class="at">size =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## Warning in geom_point(data = filtered_df, aes(x = longitude, y = latitude, :
## Ignoring unknown aesthetics: text</code></pre>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="chapter-case-ma-pm25.html#cb190-1" tabindex="-1"></a><span class="co"># you can run this block code on your local to have mouse hover text.</span></span>
<span id="cb190-2"><a href="chapter-case-ma-pm25.html#cb190-2" tabindex="-1"></a><span class="co"># for Now it cannot</span></span>
<span id="cb190-3"><a href="chapter-case-ma-pm25.html#cb190-3" tabindex="-1"></a><span class="co"># rander on R-studio connect</span></span>
<span id="cb190-4"><a href="chapter-case-ma-pm25.html#cb190-4" tabindex="-1"></a><span class="co"># Convert the plot to a plotly object</span></span>
<span id="cb190-5"><a href="chapter-case-ma-pm25.html#cb190-5" tabindex="-1"></a>run <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb190-6"><a href="chapter-case-ma-pm25.html#cb190-6" tabindex="-1"></a><span class="cf">if</span> (run <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb190-7"><a href="chapter-case-ma-pm25.html#cb190-7" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplotly</span>(p) <span class="sc">%&gt;%</span></span>
<span id="cb190-8"><a href="chapter-case-ma-pm25.html#cb190-8" tabindex="-1"></a>    <span class="fu">layout</span>(</span>
<span id="cb190-9"><a href="chapter-case-ma-pm25.html#cb190-9" tabindex="-1"></a>      <span class="at">hoverlabel =</span> <span class="fu">list</span>(<span class="at">bgcolor =</span> <span class="st">&quot;white&quot;</span>),</span>
<span id="cb190-10"><a href="chapter-case-ma-pm25.html#cb190-10" tabindex="-1"></a>      <span class="at">hovertemplate =</span> <span class="fu">paste</span>(</span>
<span id="cb190-11"><a href="chapter-case-ma-pm25.html#cb190-11" tabindex="-1"></a>        <span class="st">&quot;&lt;b&gt;%{text}&lt;/b&gt;&quot;</span></span>
<span id="cb190-12"><a href="chapter-case-ma-pm25.html#cb190-12" tabindex="-1"></a>      )</span>
<span id="cb190-13"><a href="chapter-case-ma-pm25.html#cb190-13" tabindex="-1"></a>    )</span>
<span id="cb190-14"><a href="chapter-case-ma-pm25.html#cb190-14" tabindex="-1"></a>}</span></code></pre></div>
<p>Draw the map</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="chapter-case-ma-pm25.html#cb191-1" tabindex="-1"></a><span class="fu">print</span>(p)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-172-1.png" width="672" /></p>

</div>
</div>
<div id="mapping-linked-census-income-data" class="section level3 hasAnchor" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> Mapping Linked Census Income Data<a href="chapter-case-ma-pm25.html#mapping-linked-census-income-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="data-preparation" class="section level4 unnumbered hasAnchor">
<h4>Data Preparation<a href="chapter-case-ma-pm25.html#data-preparation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Data set is from Synthetic patient and population health data from the state of Massachusetts</p>
<ol style="list-style-type: decimal">
<li><p>Download complete patients FHIR file from <a href="https://synthea.mitre.org/downloads" class="uri">https://synthea.mitre.org/downloads</a> 22G zip tar</p></li>
<li><p>Developed python <a href="https://github.com/NIEHS/pcor_climate_tools/blob/main/geospatial_analysis/data_wrangling/fhir_dataset.py" title="File github location">fhir_dataset.py</a> to pull the patients information : patientid, lat, lon, birthdate, gender , start_date_time, end_date_time, code, code_display, start_date, end_date Total patients: 1 million patients</p>
<p>sample result: ran synthea_1m_fhir_3_0_May_24/output_12 code =183478001</p>
<p>output file : patient_encounts_bycode_v2_12.csv</p></li>
<li><p>QC dataset. for instance : start date &gt; end date ; misplace birth/death date to hospital stay date<br />
</p></li>
<li><p>Using the start/end date from patients file run DeGauss pm2.5 model <a href="https://degauss.org/pm/" class="uri">https://degauss.org/pm/</a></p>
<p>input file for pm2.5 from step 2 command line:docker run –rm -v $PWD:/tmp ghcr.io/degauss-org/pm:0.2.0 tmp/yourdatafile.csv</p></li>
<li><p>The following columns been added for each row:</p>
<p>pm_pred : predicted PM2.5 (micrograms per cubic meter)</p>
<p>pm_se : standard error for predicted PM2.5</p>
<p>Output file: patient_encounts_bycode_v2_12_pm_0.2.0.csv</p></li>
</ol>
<p>The output file will contain one row per day between start_date and end_date for everyone. Lat(latitude) and lon (longitude) location. This means that the output file will likely contain many more rows than the input file</p>
<ol start="6" style="list-style-type: decimal">
<li><p>Run deGUAUSS census block group : <a href="https://degauss.org/census_block_group/" class="uri">https://degauss.org/census_block_group/</a> Produced a file with additional columns:</p>
<p>• census_block_group_id_2010: identifier for 2010 block group</p>
<p>• census_tract_id_2010: identifier for 2010 tract</p>
<p>• command line:docker run –rm -v $PWD:/tmp ghcr.io/degauss-org/census_block_group:0.5.0 tmp/yourdatafile.csv</p>
<p>Output file: yourdatafile_census_block_group_0.6.0_2010.csv rename to:ms_patient_pm_census_v2.csv</p></li>
</ol>
<p>install packages</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="chapter-case-ma-pm25.html#cb192-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;shiny&quot;</span>) <span class="sc">||</span></span>
<span id="cb192-2"><a href="chapter-case-ma-pm25.html#cb192-2" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;tidycensus&quot;</span>) <span class="sc">||</span></span>
<span id="cb192-3"><a href="chapter-case-ma-pm25.html#cb192-3" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;tidyverse&quot;</span>) <span class="sc">||</span></span>
<span id="cb192-4"><a href="chapter-case-ma-pm25.html#cb192-4" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;viridis&quot;</span>)) {</span>
<span id="cb192-5"><a href="chapter-case-ma-pm25.html#cb192-5" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">&quot;shiny&quot;</span>, <span class="st">&quot;tidycensus&quot;</span>, <span class="st">&quot;tidyverse&quot;</span>, <span class="st">&quot;viridis&quot;</span>))</span>
<span id="cb192-6"><a href="chapter-case-ma-pm25.html#cb192-6" tabindex="-1"></a>}</span>
<span id="cb192-7"><a href="chapter-case-ma-pm25.html#cb192-7" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;plotly&quot;</span>)) {</span>
<span id="cb192-8"><a href="chapter-case-ma-pm25.html#cb192-8" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">&quot;plotly&quot;</span>, <span class="at">type =</span> <span class="st">&quot;source&quot;</span>)</span>
<span id="cb192-9"><a href="chapter-case-ma-pm25.html#cb192-9" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="chapter-case-ma-pm25.html#cb193-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;ggplot2&quot;</span>)) {</span>
<span id="cb193-2"><a href="chapter-case-ma-pm25.html#cb193-2" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">&quot;ggplot2&quot;</span>)</span>
<span id="cb193-3"><a href="chapter-case-ma-pm25.html#cb193-3" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">&quot;maps&quot;</span>, <span class="st">&quot;ggmap&quot;</span>))</span>
<span id="cb193-4"><a href="chapter-case-ma-pm25.html#cb193-4" tabindex="-1"></a>}</span>
<span id="cb193-5"><a href="chapter-case-ma-pm25.html#cb193-5" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;maps&quot;</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;ggmap&quot;</span>)) {</span>
<span id="cb193-6"><a href="chapter-case-ma-pm25.html#cb193-6" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">&quot;maps&quot;</span>, <span class="st">&quot;ggmap&quot;</span>))</span>
<span id="cb193-7"><a href="chapter-case-ma-pm25.html#cb193-7" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that the echo = FALSE parameter was added to the code chunk to prevent printing of the R code that generated the plot.
### Load libraries</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="chapter-case-ma-pm25.html#cb194-1" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb194-2"><a href="chapter-case-ma-pm25.html#cb194-2" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;./dataset/ms_patient_pm_census_v2.csv&quot;</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="chapter-case-ma-pm25.html#cb195-1" tabindex="-1"></a><span class="fu">dim</span>(df)</span></code></pre></div>
<pre><code>## [1] 2979   19</code></pre>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="chapter-case-ma-pm25.html#cb197-1" tabindex="-1"></a><span class="fu">colnames</span>(df)</span></code></pre></div>
<pre><code>##  [1] &quot;patientid&quot;                  &quot;lat&quot;                       
##  [3] &quot;lon&quot;                        &quot;birthdate&quot;                 
##  [5] &quot;gender&quot;                     &quot;start_date_time&quot;           
##  [7] &quot;end_date_time&quot;              &quot;code&quot;                      
##  [9] &quot;code_display&quot;               &quot;start_date&quot;                
## [11] &quot;end_date&quot;                   &quot;date&quot;                      
## [13] &quot;year&quot;                       &quot;h3&quot;                        
## [15] &quot;h3_3&quot;                       &quot;pm_pred&quot;                   
## [17] &quot;pm_se&quot;                      &quot;census_block_group_id_2010&quot;
## [19] &quot;census_tract_id_2010&quot;</code></pre>
</div>
<div id="get-census-income-data" class="section level4 unnumbered hasAnchor">
<h4>Get Census Income Data<a href="chapter-case-ma-pm25.html#get-census-income-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol start="7" style="list-style-type: decimal">
<li><p>Apply census api key at <a href="https://api.census.gov/data/key_signup.html" class="uri">https://api.census.gov/data/key_signup.html</a> and then supply the key to the <code>census_api_key()</code> function to use it throughout your tidycensus session.</p></li>
<li><p>Run r package tidycensus with the api key and the parameters:</p>
<p>• income code = “C17002_001”,“C17002_002”,“C17002_003”,“C17002_004”,</p>
<p>“C17002_005”,“C17002_006”,“C17002_007”, “C17002_008”</p>
<p>• geography = tract • year = 2012 • state = MA • survey = acs5</p></li>
</ol>
<p>Create a character vector named income_code containing eight elements. Each element represents a variable code related to income.</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="chapter-case-ma-pm25.html#cb199-1" tabindex="-1"></a>income_code <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb199-2"><a href="chapter-case-ma-pm25.html#cb199-2" tabindex="-1"></a>  <span class="st">&quot;C17002_001&quot;</span>, <span class="st">&quot;C17002_002&quot;</span>, <span class="st">&quot;C17002_003&quot;</span>, <span class="st">&quot;C17002_004&quot;</span>, <span class="st">&quot;C17002_005&quot;</span>, <span class="st">&quot;C17002_006&quot;</span>,</span>
<span id="cb199-3"><a href="chapter-case-ma-pm25.html#cb199-3" tabindex="-1"></a>  <span class="st">&quot;C17002_007&quot;</span>, <span class="st">&quot;C17002_008&quot;</span></span>
<span id="cb199-4"><a href="chapter-case-ma-pm25.html#cb199-4" tabindex="-1"></a>)</span>
<span id="cb199-5"><a href="chapter-case-ma-pm25.html#cb199-5" tabindex="-1"></a><span class="co"># Assign the result of the get_acs function to the variable tarr. The function retrieves</span></span>
<span id="cb199-6"><a href="chapter-case-ma-pm25.html#cb199-6" tabindex="-1"></a><span class="co"># American Community Survey (ACS) data for the     specified geography (tract), variables</span></span>
<span id="cb199-7"><a href="chapter-case-ma-pm25.html#cb199-7" tabindex="-1"></a><span class="co"># (the income_code vector), state (Massachusetts with state code 25), geometry (TRUE to</span></span>
<span id="cb199-8"><a href="chapter-case-ma-pm25.html#cb199-8" tabindex="-1"></a><span class="co"># include spatial information), survey (&quot;acs5&quot;), and year (2012).</span></span>
<span id="cb199-9"><a href="chapter-case-ma-pm25.html#cb199-9" tabindex="-1"></a></span>
<span id="cb199-10"><a href="chapter-case-ma-pm25.html#cb199-10" tabindex="-1"></a>tarr <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb199-11"><a href="chapter-case-ma-pm25.html#cb199-11" tabindex="-1"></a>  <span class="at">geography =</span> <span class="st">&quot;tract&quot;</span>, <span class="at">variables =</span> income_code,</span>
<span id="cb199-12"><a href="chapter-case-ma-pm25.html#cb199-12" tabindex="-1"></a>  <span class="at">state =</span> <span class="dv">25</span>, <span class="at">geometry =</span> <span class="cn">FALSE</span>, <span class="at">survey =</span> <span class="st">&quot;acs5&quot;</span>, <span class="at">year =</span> <span class="dv">2012</span></span>
<span id="cb199-13"><a href="chapter-case-ma-pm25.html#cb199-13" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Getting data from the 2008-2012 5-year ACS</code></pre>
<pre><code>## Warning: • You have not set a Census API key. Users without a key are limited to 500
## queries per day and may experience performance limitations.
## ℹ For best results, get a Census API key at
## http://api.census.gov/data/key_signup.html and then supply the key to the
## `census_api_key()` function to use it throughout your tidycensus session.
## This warning is displayed once per session.</code></pre>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="chapter-case-ma-pm25.html#cb202-1" tabindex="-1"></a><span class="co"># Write the census income data into csv file</span></span>
<span id="cb202-2"><a href="chapter-case-ma-pm25.html#cb202-2" tabindex="-1"></a><span class="co"># modify if (FALSE) to if (TRUE) if you run the first time</span></span>
<span id="cb202-3"><a href="chapter-case-ma-pm25.html#cb202-3" tabindex="-1"></a><span class="cf">if</span> (<span class="cn">FALSE</span>) {</span>
<span id="cb202-4"><a href="chapter-case-ma-pm25.html#cb202-4" tabindex="-1"></a>  <span class="fu">write.csv</span>(tarr, <span class="st">&quot;./dataset/income_MA_mult_incomes.csv&quot;</span>)</span>
<span id="cb202-5"><a href="chapter-case-ma-pm25.html#cb202-5" tabindex="-1"></a>}</span></code></pre></div>
<ol start="9" style="list-style-type: decimal">
<li><p>tarr column name : • Id – census track id • geoid, • name, • variable, • estimate, • moe</p></li>
<li><p>Join the patient’s information + degauss pm 2.5 + census block dataset with census income dataset by census track id</p></li>
<li><p>Data join output file : asthma_patients_pm_2_census_block_group_0.6.0_2010.csv</p></li>
</ol>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="chapter-case-ma-pm25.html#cb203-1" tabindex="-1"></a><span class="fu">dim</span>(tarr)</span></code></pre></div>
<pre><code>## [1] 11824     5</code></pre>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="chapter-case-ma-pm25.html#cb205-1" tabindex="-1"></a><span class="fu">colnames</span>(tarr)</span></code></pre></div>
<pre><code>## [1] &quot;GEOID&quot;    &quot;NAME&quot;     &quot;variable&quot; &quot;estimate&quot; &quot;moe&quot;</code></pre>
</div>
<div id="link-census-income-data-by-tract-geoid" class="section level4 unnumbered hasAnchor">
<h4>Link Census Income Data by Tract Geoid<a href="chapter-case-ma-pm25.html#link-census-income-data-by-tract-geoid" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>df column “census_block_group_id_2010” and tarr column “GEOID” are the census track id.</p>
<p>Join these two data frames</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="chapter-case-ma-pm25.html#cb207-1" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb207-2"><a href="chapter-case-ma-pm25.html#cb207-2" tabindex="-1"></a>merge <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb207-3"><a href="chapter-case-ma-pm25.html#cb207-3" tabindex="-1"></a><span class="cf">if</span> (merge <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb207-4"><a href="chapter-case-ma-pm25.html#cb207-4" tabindex="-1"></a>  merged_frame <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb207-5"><a href="chapter-case-ma-pm25.html#cb207-5" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">census_tract_id_2010 =</span> <span class="fu">as.character</span>(census_tract_id_2010)) <span class="sc">%&gt;%</span></span>
<span id="cb207-6"><a href="chapter-case-ma-pm25.html#cb207-6" tabindex="-1"></a>    <span class="fu">inner_join</span>(tarr, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;GEOID&quot;</span> <span class="ot">=</span> <span class="st">&quot;census_tract_id_2010&quot;</span>))</span>
<span id="cb207-7"><a href="chapter-case-ma-pm25.html#cb207-7" tabindex="-1"></a>}</span>
<span id="cb207-8"><a href="chapter-case-ma-pm25.html#cb207-8" tabindex="-1"></a></span>
<span id="cb207-9"><a href="chapter-case-ma-pm25.html#cb207-9" tabindex="-1"></a><span class="co"># left join produce the same result as inner_join</span></span>
<span id="cb207-10"><a href="chapter-case-ma-pm25.html#cb207-10" tabindex="-1"></a>left_merged_frame <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb207-11"><a href="chapter-case-ma-pm25.html#cb207-11" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">census_tract_id_2010 =</span> <span class="fu">as.character</span>(census_tract_id_2010)) <span class="sc">%&gt;%</span></span>
<span id="cb207-12"><a href="chapter-case-ma-pm25.html#cb207-12" tabindex="-1"></a>  <span class="fu">left_join</span>(tarr, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;census_tract_id_2010&quot;</span> <span class="ot">=</span> <span class="st">&quot;GEOID&quot;</span>))</span></code></pre></div>
<pre><code>## Warning in left_join(., tarr, by = c(census_tract_id_2010 = &quot;GEOID&quot;)): Detected an unexpected many-to-many relationship between `x` and `y`.
## ℹ Row 1 of `x` matches multiple rows in `y`.
## ℹ Row 11769 of `y` matches multiple rows in `x`.
## ℹ If a many-to-many relationship is expected, set `relationship =
##   &quot;many-to-many&quot;` to silence this warning.</code></pre>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="chapter-case-ma-pm25.html#cb209-1" tabindex="-1"></a><span class="co"># Write the merged frame data into csv file</span></span>
<span id="cb209-2"><a href="chapter-case-ma-pm25.html#cb209-2" tabindex="-1"></a><span class="co"># modify if (FALSE) to if (TRUE) if you run the first time</span></span>
<span id="cb209-3"><a href="chapter-case-ma-pm25.html#cb209-3" tabindex="-1"></a><span class="cf">if</span> (<span class="cn">FALSE</span>) {</span>
<span id="cb209-4"><a href="chapter-case-ma-pm25.html#cb209-4" tabindex="-1"></a>  <span class="fu">write.csv</span>(left_merged_frame, <span class="st">&quot;./dataset/merged_income_MA_mult_incomes.csv&quot;</span>)</span>
<span id="cb209-5"><a href="chapter-case-ma-pm25.html#cb209-5" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="chapter-case-ma-pm25.html#cb210-1" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div>
</div>
<div id="identify-county-with-hightest-income-in-2020" class="section level4 unnumbered hasAnchor">
<h4>Identify County with Hightest Income in 2020<a href="chapter-case-ma-pm25.html#identify-county-with-hightest-income-in-2020" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="chapter-case-ma-pm25.html#cb211-1" tabindex="-1"></a><span class="co"># Fetch ACS data for Massachusetts counties</span></span>
<span id="cb211-2"><a href="chapter-case-ma-pm25.html#cb211-2" tabindex="-1"></a>ma_counties <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(</span>
<span id="cb211-3"><a href="chapter-case-ma-pm25.html#cb211-3" tabindex="-1"></a>  <span class="at">geography =</span> <span class="st">&quot;county&quot;</span>,</span>
<span id="cb211-4"><a href="chapter-case-ma-pm25.html#cb211-4" tabindex="-1"></a>  <span class="at">variables =</span> <span class="st">&quot;B19013_001&quot;</span>,</span>
<span id="cb211-5"><a href="chapter-case-ma-pm25.html#cb211-5" tabindex="-1"></a>  <span class="at">state =</span> <span class="st">&quot;MA&quot;</span>,</span>
<span id="cb211-6"><a href="chapter-case-ma-pm25.html#cb211-6" tabindex="-1"></a>  <span class="at">year =</span> <span class="dv">2020</span></span>
<span id="cb211-7"><a href="chapter-case-ma-pm25.html#cb211-7" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Getting data from the 2016-2020 5-year ACS</code></pre>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="chapter-case-ma-pm25.html#cb213-1" tabindex="-1"></a><span class="co"># Sort the data by median household income in descending order</span></span>
<span id="cb213-2"><a href="chapter-case-ma-pm25.html#cb213-2" tabindex="-1"></a>ma_counties_sorted <span class="ot">&lt;-</span> ma_counties <span class="sc">%&gt;%</span></span>
<span id="cb213-3"><a href="chapter-case-ma-pm25.html#cb213-3" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(estimate))</span>
<span id="cb213-4"><a href="chapter-case-ma-pm25.html#cb213-4" tabindex="-1"></a></span>
<span id="cb213-5"><a href="chapter-case-ma-pm25.html#cb213-5" tabindex="-1"></a><span class="co"># Extract the county with the highest income</span></span>
<span id="cb213-6"><a href="chapter-case-ma-pm25.html#cb213-6" tabindex="-1"></a>highest_income_county <span class="ot">&lt;-</span> ma_counties_sorted<span class="sc">$</span>NAME[<span class="dv">1</span>]</span>
<span id="cb213-7"><a href="chapter-case-ma-pm25.html#cb213-7" tabindex="-1"></a></span>
<span id="cb213-8"><a href="chapter-case-ma-pm25.html#cb213-8" tabindex="-1"></a><span class="co"># Print the county with the highest income</span></span>
<span id="cb213-9"><a href="chapter-case-ma-pm25.html#cb213-9" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;The county with the highest income in Massachusetts is:&quot;</span>,</span>
<span id="cb213-10"><a href="chapter-case-ma-pm25.html#cb213-10" tabindex="-1"></a>    highest_income_county)</span></code></pre></div>
<pre><code>## The county with the highest income in Massachusetts is: Nantucket County, Massachusetts</code></pre>
</div>
<div id="map-income-and-patient-data" class="section level4 unnumbered hasAnchor">
<h4>Map Income and Patient Data<a href="chapter-case-ma-pm25.html#map-income-and-patient-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="chapter-case-ma-pm25.html#cb215-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;maps&quot;</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">require</span>(<span class="st">&quot;ggmap&quot;</span>)) {</span>
<span id="cb215-2"><a href="chapter-case-ma-pm25.html#cb215-2" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">&quot;maps&quot;</span>, <span class="st">&quot;ggmap&quot;</span>))</span>
<span id="cb215-3"><a href="chapter-case-ma-pm25.html#cb215-3" tabindex="-1"></a>  <span class="fu">library</span>(maps)</span>
<span id="cb215-4"><a href="chapter-case-ma-pm25.html#cb215-4" tabindex="-1"></a>  <span class="fu">library</span>(ggmap)</span>
<span id="cb215-5"><a href="chapter-case-ma-pm25.html#cb215-5" tabindex="-1"></a>}</span>
<span id="cb215-6"><a href="chapter-case-ma-pm25.html#cb215-6" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code></pre></div>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="chapter-case-ma-pm25.html#cb216-1" tabindex="-1"></a><span class="fu">colnames</span>(left_merged_frame)</span></code></pre></div>
<pre><code>##  [1] &quot;patientid&quot;                  &quot;lat&quot;                       
##  [3] &quot;lon&quot;                        &quot;birthdate&quot;                 
##  [5] &quot;gender&quot;                     &quot;start_date_time&quot;           
##  [7] &quot;end_date_time&quot;              &quot;code&quot;                      
##  [9] &quot;code_display&quot;               &quot;start_date&quot;                
## [11] &quot;end_date&quot;                   &quot;date&quot;                      
## [13] &quot;year&quot;                       &quot;h3&quot;                        
## [15] &quot;h3_3&quot;                       &quot;pm_pred&quot;                   
## [17] &quot;pm_se&quot;                      &quot;census_block_group_id_2010&quot;
## [19] &quot;census_tract_id_2010&quot;       &quot;NAME&quot;                      
## [21] &quot;variable&quot;                   &quot;estimate&quot;                  
## [23] &quot;moe&quot;</code></pre>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="chapter-case-ma-pm25.html#cb218-1" tabindex="-1"></a><span class="co"># Draw Massachusetts map</span></span>
<span id="cb218-2"><a href="chapter-case-ma-pm25.html#cb218-2" tabindex="-1"></a>ma_map <span class="ot">&lt;-</span> <span class="fu">map_data</span>(<span class="st">&quot;state&quot;</span>, <span class="at">region =</span> <span class="st">&quot;massachusetts&quot;</span>)</span>
<span id="cb218-3"><a href="chapter-case-ma-pm25.html#cb218-3" tabindex="-1"></a><span class="co"># modify column&#39;s name</span></span>
<span id="cb218-4"><a href="chapter-case-ma-pm25.html#cb218-4" tabindex="-1"></a><span class="fu">colnames</span>(left_merged_frame)[<span class="fu">which</span>(<span class="fu">names</span>(left_merged_frame) <span class="sc">==</span> <span class="st">&quot;lon&quot;</span>)] <span class="ot">&lt;-</span></span>
<span id="cb218-5"><a href="chapter-case-ma-pm25.html#cb218-5" tabindex="-1"></a>  <span class="st">&quot;longitude&quot;</span></span>
<span id="cb218-6"><a href="chapter-case-ma-pm25.html#cb218-6" tabindex="-1"></a><span class="fu">colnames</span>(left_merged_frame)[<span class="fu">which</span>(<span class="fu">names</span>(left_merged_frame) <span class="sc">==</span> <span class="st">&quot;lat&quot;</span>)] <span class="ot">&lt;-</span></span>
<span id="cb218-7"><a href="chapter-case-ma-pm25.html#cb218-7" tabindex="-1"></a>  <span class="st">&quot;latitude&quot;</span></span>
<span id="cb218-8"><a href="chapter-case-ma-pm25.html#cb218-8" tabindex="-1"></a></span>
<span id="cb218-9"><a href="chapter-case-ma-pm25.html#cb218-9" tabindex="-1"></a><span class="co"># Optional Filter the rows based on the date range Use the subset() function to</span></span>
<span id="cb218-10"><a href="chapter-case-ma-pm25.html#cb218-10" tabindex="-1"></a><span class="co"># filter the rows based on the date range:2012 -2017to match 5 year sensus data</span></span>
<span id="cb218-11"><a href="chapter-case-ma-pm25.html#cb218-11" tabindex="-1"></a></span>
<span id="cb218-12"><a href="chapter-case-ma-pm25.html#cb218-12" tabindex="-1"></a>filtered_df <span class="ot">&lt;-</span> <span class="fu">subset</span>(</span>
<span id="cb218-13"><a href="chapter-case-ma-pm25.html#cb218-13" tabindex="-1"></a>  left_merged_frame,</span>
<span id="cb218-14"><a href="chapter-case-ma-pm25.html#cb218-14" tabindex="-1"></a>  date <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">&quot;2012-09-01&quot;</span>) <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> <span class="fu">as.Date</span>(<span class="st">&quot;2017-09-01&quot;</span>)</span>
<span id="cb218-15"><a href="chapter-case-ma-pm25.html#cb218-15" tabindex="-1"></a>)</span>
<span id="cb218-16"><a href="chapter-case-ma-pm25.html#cb218-16" tabindex="-1"></a></span>
<span id="cb218-17"><a href="chapter-case-ma-pm25.html#cb218-17" tabindex="-1"></a><span class="co"># Create a base plot for Massachusetts</span></span>
<span id="cb218-18"><a href="chapter-case-ma-pm25.html#cb218-18" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb218-19"><a href="chapter-case-ma-pm25.html#cb218-19" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(</span>
<span id="cb218-20"><a href="chapter-case-ma-pm25.html#cb218-20" tabindex="-1"></a>    <span class="at">data =</span> ma_map, <span class="fu">aes</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat, <span class="at">group =</span> group),</span>
<span id="cb218-21"><a href="chapter-case-ma-pm25.html#cb218-21" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb218-22"><a href="chapter-case-ma-pm25.html#cb218-22" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb218-23"><a href="chapter-case-ma-pm25.html#cb218-23" tabindex="-1"></a>  <span class="co"># Plot the data points</span></span>
<span id="cb218-24"><a href="chapter-case-ma-pm25.html#cb218-24" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb218-25"><a href="chapter-case-ma-pm25.html#cb218-25" tabindex="-1"></a>    <span class="at">data =</span> filtered_df,</span>
<span id="cb218-26"><a href="chapter-case-ma-pm25.html#cb218-26" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">color =</span> estimate),</span>
<span id="cb218-27"><a href="chapter-case-ma-pm25.html#cb218-27" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb218-28"><a href="chapter-case-ma-pm25.html#cb218-28" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb218-29"><a href="chapter-case-ma-pm25.html#cb218-29" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Income vs patient Map&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Longitude&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span></span>
<span id="cb218-30"><a href="chapter-case-ma-pm25.html#cb218-30" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(<span class="at">low =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">high =</span> <span class="st">&quot;red&quot;</span>, <span class="at">name =</span> <span class="st">&quot;estimate&quot;</span>) <span class="sc">+</span></span>
<span id="cb218-31"><a href="chapter-case-ma-pm25.html#cb218-31" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb218-32"><a href="chapter-case-ma-pm25.html#cb218-32" tabindex="-1"></a>  <span class="co"># Adjust the map boundaries to focus on Massachusetts</span></span>
<span id="cb218-33"><a href="chapter-case-ma-pm25.html#cb218-33" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">73.5</span>, <span class="sc">-</span><span class="fl">69.9</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">41.2</span>, <span class="fl">42.9</span>))</span>
<span id="cb218-34"><a href="chapter-case-ma-pm25.html#cb218-34" tabindex="-1"></a></span>
<span id="cb218-35"><a href="chapter-case-ma-pm25.html#cb218-35" tabindex="-1"></a><span class="co"># Print the map</span></span>
<span id="cb218-36"><a href="chapter-case-ma-pm25.html#cb218-36" tabindex="-1"></a><span class="fu">print</span>(p)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-185-1.png" width="672" /></p>

</div>
</div>
<div id="visualize-air-pollution-and-health-information-using-bivariate-maps" class="section level3 unnumbered hasAnchor">
<h3>Visualize Air Pollution and Health Information Using Bivariate Maps<a href="chapter-case-ma-pm25.html#visualize-air-pollution-and-health-information-using-bivariate-maps" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="set-up-bivariate-color-classes" class="section level4 unnumbered hasAnchor">
<h4>Set Up Bivariate Color Classes<a href="chapter-case-ma-pm25.html#set-up-bivariate-color-classes" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Each variate is divided into thirds (based on percentiles) and a joint classification for all 9 combinations is defined.</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="chapter-case-ma-pm25.html#cb219-1" tabindex="-1"></a><span class="fu">require</span>(latticeExtra) <span class="co"># uscancerrates, mapplot</span></span></code></pre></div>
<pre><code>## Loading required package: latticeExtra</code></pre>
<pre><code>## Loading required package: lattice</code></pre>
<pre><code>## 
## Attaching package: &#39;latticeExtra&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:ggplot2&#39;:
## 
##     layer</code></pre>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="chapter-case-ma-pm25.html#cb224-1" tabindex="-1"></a><span class="fu">require</span>(maps) <span class="co"># map</span></span>
<span id="cb224-2"><a href="chapter-case-ma-pm25.html#cb224-2" tabindex="-1"></a><span class="fu">require</span>(classInt) <span class="co"># classIntervals, findCols</span></span></code></pre></div>
<pre><code>## Loading required package: classInt</code></pre>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="chapter-case-ma-pm25.html#cb226-1" tabindex="-1"></a><span class="fu">require</span>(grid) <span class="co"># viewport, pushViewport</span></span></code></pre></div>
<pre><code>## Loading required package: grid</code></pre>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="chapter-case-ma-pm25.html#cb228-1" tabindex="-1"></a><span class="fu">require</span>(pals) <span class="co"># brewer.blues, stevens.pinkgreen</span></span></code></pre></div>
<pre><code>## Loading required package: pals</code></pre>
<pre><code>## 
## Attaching package: &#39;pals&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:viridis&#39;:
## 
##     cividis, inferno, magma, plasma, turbo, viridis</code></pre>
<pre><code>## The following objects are masked from &#39;package:viridisLite&#39;:
## 
##     cividis, inferno, magma, plasma, turbo, viridis</code></pre>
<p>From asthma_patients_pm_2_census_block_group_0.6.0_2010.csv run python biv_cho_map.py call fcc api to get county FIPS and Name for each patient <a href="https://geo.fcc.gov/api/census/#!/block/get_block_find" class="uri">https://geo.fcc.gov/api/census/#!/block/get_block_find</a> new data fileasthma_patients_pm_2_census_block_group_0.6.0_2010.csv</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="chapter-case-ma-pm25.html#cb233-1" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb233-2"><a href="chapter-case-ma-pm25.html#cb233-2" tabindex="-1"></a>df_county <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;./dataset/county.csv&quot;</span>)</span>
<span id="cb233-3"><a href="chapter-case-ma-pm25.html#cb233-3" tabindex="-1"></a><span class="fu">head</span>(df_county)</span></code></pre></div>
<pre><code>##   X Unnamed..0                            patientid      lat       lon
## 1 0          1 04a4d323-9115-49d8-b44f-f166c331c948 41.73322 -70.12610
## 2 1          2 cea474c2-e254-4004-9687-332aba93ad1f 42.71344 -70.83298
## 3 2          3 c3b51f04-41a8-4794-b195-02a9a6ace417 42.09928 -70.68884
## 4 3          4 03329b9a-1f93-45a9-b73f-50039543b544 42.32161 -70.92707
## 5 4          5 086a79cc-7ba9-4c18-ba01-7ee6085ae262 41.70227 -71.09501
## 6 5          6 43f4fccc-e592-48a4-a513-3b792f9d6220 42.43578 -71.06075
##       start_date_time       end_date_time  birthdate gender      code
## 1 2012-01-23 22:44:49 2012-01-23 22:44:49 1989-05-11   male 183478001
## 2 2012-05-15 20:33:03 2012-05-15 20:33:03 1965-02-05   male 183478001
## 3 2012-07-24 07:37:29 2012-07-24 07:37:29 1986-03-11   male 183478001
## 4 2012-03-14 08:10:33 2012-03-14 08:10:33 1977-03-13   male 183478001
## 5 2012-01-21 17:22:20 2012-01-21 17:22:20 1986-12-20   male 183478001
## 6 2012-05-17 21:10:17 2012-05-17 21:10:17 1983-04-28   male 183478001
##                              code_display start_date   end_date       date year
## 1 Emergency hospital admission for asthma 2012-01-23 2012-01-23 2012-01-23 2012
## 2 Emergency hospital admission for asthma 2012-05-15 2012-05-15 2012-05-15 2012
## 3 Emergency hospital admission for asthma 2012-07-24 2012-07-24 2012-07-24 2012
## 4 Emergency hospital admission for asthma 2012-03-14 2012-03-14 2012-03-14 2012
## 5 Emergency hospital admission for asthma 2012-01-21 2012-01-21 2012-01-21 2012
## 6 Emergency hospital admission for asthma 2012-05-17 2012-05-17 2012-05-17 2012
##                h3                            h3_3   pm_pred    pm_se
## 1 882a310e69fffff 832a06fffffffff-832a31fffffffff  9.912325 1.858255
## 2 882a3001c9fffff                 832a30fffffffff 10.397400 3.698060
## 3 882a315b1bfffff 832a06fffffffff-832a31fffffffff  9.668475 2.096010
## 4 882a30283dfffff                 832a30fffffffff  7.458575 1.795863
## 5 882a33a143fffff                 832a33fffffffff  7.068950 2.226050
## 6 882a3075c3fffff                 832a30fffffffff 10.952550 2.895613
##   census_block_group_id_2010 census_tract_id_2010 county_code       county_name
## 1               250010108005          25001010800       25001 Barnstable County
## 2               250092231002          25009223100       25009      Essex County
## 3               250235062031          25023506203       25023   Plymouth County
## 4               250259801011          25025980101       25025    Suffolk County
## 5               250056425002          25005642500       25005    Bristol County
## 6               250173416003          25017341600       25017  Middlesex County</code></pre>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="chapter-case-ma-pm25.html#cb235-1" tabindex="-1"></a>df_census_block <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;./dataset/asthma_patients_pm_2_census_block_group_0.6.0_2010.csv&quot;</span>)</span>
<span id="cb235-2"><a href="chapter-case-ma-pm25.html#cb235-2" tabindex="-1"></a><span class="fu">head</span>(df_census_block)</span></code></pre></div>
<pre><code>##                              patientid      lat       lon      start_date_time
## 1 aeeed2fd-b274-4947-b4c4-36e6f8d6fe48 42.03064 -71.49793 2011-04-02T11:32:13Z
## 2 2ff614fb-652d-4f83-89db-f66942a75dd4 42.27744 -71.82262 2010-12-30T02:39:26Z
## 3 7aad32c1-35f2-4522-9a16-08122504f981 42.58764 -72.52155 2010-11-06T04:36:07Z
## 4 f78662b4-ab83-43ae-bdbf-04668d4ba1c5 42.47049 -70.92015 2010-11-07T15:25:16Z
## 5 d9419f62-2212-47f6-9537-854289b1ccaa 42.34944 -73.26774 2011-03-30T16:39:36Z
## 6 ae0265e4-e679-46b7-ad5f-f6fb3a25072d 42.72983 -71.15126 2010-10-19T09:14:56Z
##          end_date_time  birthdate gender      code
## 1 2011-04-02T11:32:13Z 1980-05-22 female 183478001
## 2 2010-12-30T02:39:26Z 1983-03-29   male 183478001
## 3 2010-11-06T04:36:07Z 2003-04-15 female 183478001
## 4 2010-11-07T15:25:16Z 1951-09-11 female 183478001
## 5 2011-03-30T16:39:36Z 1999-06-25   male 183478001
## 6 2010-10-19T09:14:56Z 1954-07-24 female 183478001
##                              code_display start_date   end_date       date year
## 1 Emergency hospital admission for asthma 2011-04-02 2011-04-02 2011-04-02 2011
## 2 Emergency hospital admission for asthma 2010-12-30 2010-12-30 2010-12-30 2010
## 3 Emergency hospital admission for asthma 2010-11-06 2010-11-06 2010-11-06 2010
## 4 Emergency hospital admission for asthma 2010-11-07 2010-11-07 2010-11-07 2010
## 5 Emergency hospital admission for asthma 2011-03-30 2011-03-30 2011-03-30 2011
## 6 Emergency hospital admission for asthma 2010-10-19 2010-10-19 2010-10-19 2010
##                h3            h3_3   pm_pred     pm_se
## 1 882a33c6b1fffff 832a33fffffffff  4.738200 0.8280494
## 2 882a33d99dfffff 832a33fffffffff 20.799600 5.4792723
## 3 882a320d31fffff 832a32fffffffff  3.553875 1.1884528
## 4 882a3076cdfffff 832a30fffffffff  5.397100 1.4094668
## 5 882a14da25fffff 832a14fffffffff  4.359900 1.0133038
## 6 882a3046e9fffff 832a30fffffffff  8.406375 2.6272480
##   census_block_group_id_2010 census_tract_id_2010
## 1               250277471012          25027747101
## 2               250277308012          25027730801
## 3               250110407022          25011040702
## 4               250092021013          25009202101
## 5               250039131007          25003913100
## 6               250092525022          25009252502</code></pre>
</div>
<div id="get-ma-county-boundaries" class="section level4 unnumbered hasAnchor">
<h4>Get MA County Boundaries<a href="chapter-case-ma-pm25.html#get-ma-county-boundaries" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Aggregate the data by county, calculating the total number of patients and the mean pm2.5_pred:</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="chapter-case-ma-pm25.html#cb237-1" tabindex="-1"></a>df_agg <span class="ot">&lt;-</span> df_county <span class="sc">%&gt;%</span></span>
<span id="cb237-2"><a href="chapter-case-ma-pm25.html#cb237-2" tabindex="-1"></a>  <span class="fu">group_by</span>(county_code) <span class="sc">%&gt;%</span></span>
<span id="cb237-3"><a href="chapter-case-ma-pm25.html#cb237-3" tabindex="-1"></a>  <span class="fu">reframe</span>(</span>
<span id="cb237-4"><a href="chapter-case-ma-pm25.html#cb237-4" tabindex="-1"></a>    <span class="at">patient_count =</span> <span class="fu">n</span>(),</span>
<span id="cb237-5"><a href="chapter-case-ma-pm25.html#cb237-5" tabindex="-1"></a>    county_name,</span>
<span id="cb237-6"><a href="chapter-case-ma-pm25.html#cb237-6" tabindex="-1"></a>    <span class="at">pm2_mean =</span> <span class="fu">mean</span>(pm_pred, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb237-7"><a href="chapter-case-ma-pm25.html#cb237-7" tabindex="-1"></a>  )</span></code></pre></div>
</div>
</div>
<div id="join-census-data-with-county-boundaries" class="section level3 hasAnchor" number="6.3.3">
<h3><span class="header-section-number">6.3.3</span> Join Census Data with County Boundaries<a href="chapter-case-ma-pm25.html#join-census-data-with-county-boundaries" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="chapter-case-ma-pm25.html#cb238-1" tabindex="-1"></a><span class="fu">dim</span>(df_agg)</span></code></pre></div>
<pre><code>## [1] 96  4</code></pre>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="chapter-case-ma-pm25.html#cb240-1" tabindex="-1"></a>ma_counties_data <span class="ot">&lt;-</span> us_counties_MA <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(df_agg, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;NAMELSAD&quot;</span> <span class="ot">=</span> <span class="st">&quot;county_name&quot;</span>))</span>
<span id="cb240-2"><a href="chapter-case-ma-pm25.html#cb240-2" tabindex="-1"></a><span class="fu">head</span>(ma_counties_data)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 15 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: -72.31582 ymin: 42.00806 xmax: -71.47803 ymax: 42.72156
## Geodetic CRS:  NAD83
##   STATEFP COUNTYFP COUNTYNS       AFFGEOID GEOID      NAME         NAMELSAD
## 1      25      027 00606940 0500000US25027 25027 Worcester Worcester County
## 2      25      027 00606940 0500000US25027 25027 Worcester Worcester County
## 3      25      027 00606940 0500000US25027 25027 Worcester Worcester County
## 4      25      027 00606940 0500000US25027 25027 Worcester Worcester County
## 5      25      027 00606940 0500000US25027 25027 Worcester Worcester County
## 6      25      027 00606940 0500000US25027 25027 Worcester Worcester County
##   STUSPS    STATE_NAME LSAD      ALAND    AWATER county_code patient_count
## 1     MA Massachusetts   06 3912627580 177366263       25027            16
## 2     MA Massachusetts   06 3912627580 177366263       25027            16
## 3     MA Massachusetts   06 3912627580 177366263       25027            16
## 4     MA Massachusetts   06 3912627580 177366263       25027            16
## 5     MA Massachusetts   06 3912627580 177366263       25027            16
## 6     MA Massachusetts   06 3912627580 177366263       25027            16
##   pm2_mean                       geometry
## 1 5.862477 MULTIPOLYGON (((-72.31363 4...
## 2 5.862477 MULTIPOLYGON (((-72.31363 4...
## 3 5.862477 MULTIPOLYGON (((-72.31363 4...
## 4 5.862477 MULTIPOLYGON (((-72.31363 4...
## 5 5.862477 MULTIPOLYGON (((-72.31363 4...
## 6 5.862477 MULTIPOLYGON (((-72.31363 4...</code></pre>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="chapter-case-ma-pm25.html#cb242-1" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb242-2"><a href="chapter-case-ma-pm25.html#cb242-2" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> ma_counties_data,</span>
<span id="cb242-3"><a href="chapter-case-ma-pm25.html#cb242-3" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">fill =</span> patient_count),</span>
<span id="cb242-4"><a href="chapter-case-ma-pm25.html#cb242-4" tabindex="-1"></a>          <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb242-5"><a href="chapter-case-ma-pm25.html#cb242-5" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>() <span class="sc">+</span></span>
<span id="cb242-6"><a href="chapter-case-ma-pm25.html#cb242-6" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb242-7"><a href="chapter-case-ma-pm25.html#cb242-7" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span></span>
<span id="cb242-8"><a href="chapter-case-ma-pm25.html#cb242-8" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Patient count&quot;</span>)</span></code></pre></div>
<div id="set-color-on-both-varaibles" class="section level4 unnumbered hasAnchor">
<h4>Set Color on Both Varaibles<a href="chapter-case-ma-pm25.html#set-color-on-both-varaibles" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="chapter-case-ma-pm25.html#cb243-1" tabindex="-1"></a>cols <span class="ot">&lt;-</span> stevens.pinkgreen</span>
<span id="cb243-2"><a href="chapter-case-ma-pm25.html#cb243-2" tabindex="-1"></a>nbins <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb243-3"><a href="chapter-case-ma-pm25.html#cb243-3" tabindex="-1"></a></span>
<span id="cb243-4"><a href="chapter-case-ma-pm25.html#cb243-4" tabindex="-1"></a><span class="co"># categorize rates into 3 percentile bins</span></span>
<span id="cb243-5"><a href="chapter-case-ma-pm25.html#cb243-5" tabindex="-1"></a>brks_pm <span class="ot">&lt;-</span> <span class="fu">classIntervals</span>(</span>
<span id="cb243-6"><a href="chapter-case-ma-pm25.html#cb243-6" tabindex="-1"></a>  <span class="fu">log</span>(ma_counties_data<span class="sc">$</span>pm2_mean),</span>
<span id="cb243-7"><a href="chapter-case-ma-pm25.html#cb243-7" tabindex="-1"></a>  <span class="at">n =</span> nbins,</span>
<span id="cb243-8"><a href="chapter-case-ma-pm25.html#cb243-8" tabindex="-1"></a>  <span class="at">style =</span> <span class="st">&quot;quantile&quot;</span></span>
<span id="cb243-9"><a href="chapter-case-ma-pm25.html#cb243-9" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning in classIntervals(log(ma_counties_data$pm2_mean), n = nbins, style =
## &quot;quantile&quot;): var has missing values, omitted in finding classes</code></pre>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="chapter-case-ma-pm25.html#cb245-1" tabindex="-1"></a>brks_patient <span class="ot">&lt;-</span> <span class="fu">classIntervals</span>(</span>
<span id="cb245-2"><a href="chapter-case-ma-pm25.html#cb245-2" tabindex="-1"></a>  <span class="fu">log</span>(ma_counties_data<span class="sc">$</span>patient_count),</span>
<span id="cb245-3"><a href="chapter-case-ma-pm25.html#cb245-3" tabindex="-1"></a>  <span class="at">n =</span> nbins,</span>
<span id="cb245-4"><a href="chapter-case-ma-pm25.html#cb245-4" tabindex="-1"></a>  <span class="at">style =</span> <span class="st">&quot;quantile&quot;</span></span>
<span id="cb245-5"><a href="chapter-case-ma-pm25.html#cb245-5" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning in classIntervals(log(ma_counties_data$patient_count), n = nbins, : var
## has missing values, omitted in finding classes</code></pre>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="chapter-case-ma-pm25.html#cb247-1" tabindex="-1"></a>class_pm <span class="ot">&lt;-</span> <span class="fu">findCols</span>(brks_pm)</span>
<span id="cb247-2"><a href="chapter-case-ma-pm25.html#cb247-2" tabindex="-1"></a><span class="fu">print</span>(class_pm)</span></code></pre></div>
<pre><code>##  [1]  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1 NA  3  3  3  3  3  3  3  3
## [26]  3  3  3  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2
## [51]  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  3  3  3  3  3  3  3  3  3
## [76]  3  3  3  3  3  3  3 NA  2  2  3  3  3  3  1  1  1  1  1  1  1  1 NA  3</code></pre>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="chapter-case-ma-pm25.html#cb249-1" tabindex="-1"></a>class_patient <span class="ot">&lt;-</span> <span class="fu">findCols</span>(brks_patient)</span>
<span id="cb249-2"><a href="chapter-case-ma-pm25.html#cb249-2" tabindex="-1"></a><span class="co"># convert x,y classes into a joint class x+3(y-1)</span></span>
<span id="cb249-3"><a href="chapter-case-ma-pm25.html#cb249-3" tabindex="-1"></a>ma_counties_data<span class="sc">$</span>class2 <span class="ot">&lt;-</span> class_pm <span class="sc">+</span> nbins <span class="sc">*</span> (class_patient <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb249-4"><a href="chapter-case-ma-pm25.html#cb249-4" tabindex="-1"></a></span>
<span id="cb249-5"><a href="chapter-case-ma-pm25.html#cb249-5" tabindex="-1"></a><span class="co"># scatterplot of two variates showing bins</span></span>
<span id="cb249-6"><a href="chapter-case-ma-pm25.html#cb249-6" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log</span>(pm2_mean) <span class="sc">~</span> <span class="fu">log</span>(patient_count),</span>
<span id="cb249-7"><a href="chapter-case-ma-pm25.html#cb249-7" tabindex="-1"></a>  <span class="at">data =</span> ma_counties_data,</span>
<span id="cb249-8"><a href="chapter-case-ma-pm25.html#cb249-8" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">cols</span>()[ma_counties_data<span class="sc">$</span>class2], <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb249-9"><a href="chapter-case-ma-pm25.html#cb249-9" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb249-10"><a href="chapter-case-ma-pm25.html#cb249-10" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-195-1.png" width="672" /></p>
</div>
<div id="map-air-pollution-and-patient-counts" class="section level4 unnumbered hasAnchor">
<h4>Map Air Pollution and Patient Counts<a href="chapter-case-ma-pm25.html#map-air-pollution-and-patient-counts" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="chapter-case-ma-pm25.html#cb250-1" tabindex="-1"></a><span class="co"># Check for missing values</span></span>
<span id="cb250-2"><a href="chapter-case-ma-pm25.html#cb250-2" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(ma_counties_data))</span>
<span id="cb250-3"><a href="chapter-case-ma-pm25.html#cb250-3" tabindex="-1"></a></span>
<span id="cb250-4"><a href="chapter-case-ma-pm25.html#cb250-4" tabindex="-1"></a><span class="co"># If there are missing values, you can drop or fill them as per your requirement</span></span>
<span id="cb250-5"><a href="chapter-case-ma-pm25.html#cb250-5" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(ma_counties_data)  <span class="co"># Drop rows with missing values</span></span></code></pre></div>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="chapter-case-ma-pm25.html#cb251-1" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">mapplot</span>(<span class="fu">rownames</span>(ma_counties_data) <span class="sc">~</span> class2,</span>
<span id="cb251-2"><a href="chapter-case-ma-pm25.html#cb251-2" tabindex="-1"></a>  <span class="at">data =</span> ma_counties_data,</span>
<span id="cb251-3"><a href="chapter-case-ma-pm25.html#cb251-3" tabindex="-1"></a>  <span class="at">colramp =</span> cols, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.5</span>, <span class="at">by =</span> <span class="dv">1</span>, <span class="at">length =</span> nbins <span class="sc">*</span> nbins <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb251-4"><a href="chapter-case-ma-pm25.html#cb251-4" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb251-5"><a href="chapter-case-ma-pm25.html#cb251-5" tabindex="-1"></a>  <span class="at">colorkey =</span> <span class="cn">FALSE</span>,</span>
<span id="cb251-6"><a href="chapter-case-ma-pm25.html#cb251-6" tabindex="-1"></a>  <span class="at">map =</span> <span class="fu">map</span>(<span class="st">&quot;state&quot;</span>, <span class="st">&quot;massachusetts&quot;</span>,</span>
<span id="cb251-7"><a href="chapter-case-ma-pm25.html#cb251-7" tabindex="-1"></a>    <span class="at">plot =</span> <span class="cn">FALSE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>,</span>
<span id="cb251-8"><a href="chapter-case-ma-pm25.html#cb251-8" tabindex="-1"></a>    <span class="at">projection =</span> <span class="st">&quot;tetra&quot;</span></span>
<span id="cb251-9"><a href="chapter-case-ma-pm25.html#cb251-9" tabindex="-1"></a>  ),</span>
<span id="cb251-10"><a href="chapter-case-ma-pm25.html#cb251-10" tabindex="-1"></a>  <span class="at">scales =</span> <span class="fu">list</span>(<span class="at">draw =</span> <span class="cn">FALSE</span>)</span>
<span id="cb251-11"><a href="chapter-case-ma-pm25.html#cb251-11" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="chapter-case-ma-pm25.html#cb252-1" tabindex="-1"></a><span class="fu">print</span>(nbins)</span>
<span id="cb252-2"><a href="chapter-case-ma-pm25.html#cb252-2" tabindex="-1"></a><span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span>(nbins <span class="sc">*</span> nbins), <span class="at">nrow =</span> nbins)</span></code></pre></div>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="chapter-case-ma-pm25.html#cb253-1" tabindex="-1"></a>m4leg <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span>(nbins <span class="sc">*</span> nbins), <span class="at">nrow =</span> nbins),</span>
<span id="cb253-2"><a href="chapter-case-ma-pm25.html#cb253-2" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">col.regions =</span> <span class="fu">cols</span>(),</span>
<span id="cb253-3"><a href="chapter-case-ma-pm25.html#cb253-3" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;patient&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;pm_2.5&quot;</span>, <span class="at">cuts =</span> <span class="dv">8</span>, <span class="at">colorkey =</span> <span class="cn">FALSE</span>,</span>
<span id="cb253-4"><a href="chapter-case-ma-pm25.html#cb253-4" tabindex="-1"></a>  <span class="at">scales =</span> <span class="fu">list</span>(<span class="at">draw =</span> <span class="dv">0</span>)</span>
<span id="cb253-5"><a href="chapter-case-ma-pm25.html#cb253-5" tabindex="-1"></a>)</span>
<span id="cb253-6"><a href="chapter-case-ma-pm25.html#cb253-6" tabindex="-1"></a></span>
<span id="cb253-7"><a href="chapter-case-ma-pm25.html#cb253-7" tabindex="-1"></a>vp <span class="ot">&lt;-</span> <span class="fu">viewport</span>(<span class="at">x =</span> .<span class="dv">15</span>, <span class="at">y =</span> .<span class="dv">25</span>, <span class="at">width =</span> .<span class="dv">3</span>, <span class="at">height =</span> .<span class="dv">3</span>)</span>
<span id="cb253-8"><a href="chapter-case-ma-pm25.html#cb253-8" tabindex="-1"></a><span class="fu">pushViewport</span>(vp)</span>
<span id="cb253-9"><a href="chapter-case-ma-pm25.html#cb253-9" tabindex="-1"></a><span class="fu">print</span>(m4leg, <span class="at">newpage =</span> <span class="cn">FALSE</span>)</span>
<span id="cb253-10"><a href="chapter-case-ma-pm25.html#cb253-10" tabindex="-1"></a><span class="fu">popViewport</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-199-1.png" width="672" /></p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="chapter-case-ma-pm25.html#cb254-1" tabindex="-1"></a><span class="fu">suppressWarnings</span>(<span class="fu">print</span>(m4))</span>
<span id="cb254-2"><a href="chapter-case-ma-pm25.html#cb254-2" tabindex="-1"></a></span>
<span id="cb254-3"><a href="chapter-case-ma-pm25.html#cb254-3" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">apply</span>(data_sample, <span class="dv">1</span>, paste, <span class="at">collapse =</span> <span class="st">&quot;&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="chapter-case-ma-pm25.html#cb255-1" tabindex="-1"></a>m4leg <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span>(nbins <span class="sc">*</span> nbins), <span class="at">nrow =</span> nbins),</span>
<span id="cb255-2"><a href="chapter-case-ma-pm25.html#cb255-2" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">col.regions =</span> <span class="fu">cols</span>(),</span>
<span id="cb255-3"><a href="chapter-case-ma-pm25.html#cb255-3" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;patient&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;pm_2.5&quot;</span>, <span class="at">cuts =</span> <span class="dv">8</span>, <span class="at">colorkey =</span> <span class="cn">FALSE</span>,</span>
<span id="cb255-4"><a href="chapter-case-ma-pm25.html#cb255-4" tabindex="-1"></a>  <span class="at">scales =</span> <span class="fu">list</span>(<span class="at">draw =</span> <span class="dv">0</span>)</span>
<span id="cb255-5"><a href="chapter-case-ma-pm25.html#cb255-5" tabindex="-1"></a>)</span>
<span id="cb255-6"><a href="chapter-case-ma-pm25.html#cb255-6" tabindex="-1"></a></span>
<span id="cb255-7"><a href="chapter-case-ma-pm25.html#cb255-7" tabindex="-1"></a><span class="co"># add the color legend</span></span>
<span id="cb255-8"><a href="chapter-case-ma-pm25.html#cb255-8" tabindex="-1"></a>m4leg <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span>(nbins <span class="sc">*</span> nbins), <span class="at">nrow =</span> nbins),</span>
<span id="cb255-9"><a href="chapter-case-ma-pm25.html#cb255-9" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">col.regions =</span> <span class="fu">cols</span>(),</span>
<span id="cb255-10"><a href="chapter-case-ma-pm25.html#cb255-10" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;patient&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;pm_2.5&quot;</span>, <span class="at">cuts =</span> <span class="dv">8</span>, <span class="at">colorkey =</span> <span class="cn">FALSE</span>,</span>
<span id="cb255-11"><a href="chapter-case-ma-pm25.html#cb255-11" tabindex="-1"></a>  <span class="at">scales =</span> <span class="fu">list</span>(<span class="at">draw =</span> <span class="dv">0</span>)</span>
<span id="cb255-12"><a href="chapter-case-ma-pm25.html#cb255-12" tabindex="-1"></a>)</span>
<span id="cb255-13"><a href="chapter-case-ma-pm25.html#cb255-13" tabindex="-1"></a>vp <span class="ot">&lt;-</span> <span class="fu">viewport</span>(<span class="at">x =</span> .<span class="dv">15</span>, <span class="at">y =</span> .<span class="dv">25</span>, <span class="at">width =</span> .<span class="dv">3</span>, <span class="at">height =</span> .<span class="dv">3</span>)</span>
<span id="cb255-14"><a href="chapter-case-ma-pm25.html#cb255-14" tabindex="-1"></a><span class="fu">pushViewport</span>(vp)</span>
<span id="cb255-15"><a href="chapter-case-ma-pm25.html#cb255-15" tabindex="-1"></a><span class="fu">print</span>(m4leg, <span class="at">newpage =</span> <span class="cn">FALSE</span>)</span>
<span id="cb255-16"><a href="chapter-case-ma-pm25.html#cb255-16" tabindex="-1"></a><span class="fu">popViewport</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-201-1.png" width="672" /></p>

</div>
</div>
</div>
</div>



            </section>

          </div>
        </div>
      </div>
<a href="case-studies.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="appendix.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
